# GPARTNER — REPORTING & DASHBOARD MASTER PLAN  
Version: 1.0  
Scope: Partner Reporting + Dashboard + LINE Alerts  
Backend: ใช้เฉพาะ Partner API ปัจจุบัน (ไม่แก้ Backend)

---

## 1. DASHBOARD (Daily / Monthly)
- รายรับรวมวันนี้ / เดือนนี้  
- kWh รวมวันนี้ / เดือนนี้  
- Total sessions  
- รายได้แยกตามตู้  
- kWh ใช้แยกตามตู้  
- Peak hour usage (Heatmap)  
- Charging efficiency (kWh/min)

---

## 2. WALLET SUMMARY (PER PARTNER)
- Total Top-up  
- Total Usage  
- Outstanding Wallet  
- Wallet by User  
- Wallet History (ledger + running balance)

---

## 3. TOP-UP REPORT
- topUpId  
- createdAt  
- amount  
- paymentMethod  
- paymentStatus  

*หมายเหตุ:* ไม่มีข้อมูล Payment Fee → ไม่คำนวณ NET

---

## 4. CHARGING SESSION REPORT
- Session ID  
- Start–End timestamp  
- User email  
- chargePoint  
- kWh used  
- Duration (minutes)  
- Revenue per session  

*Promotion ไม่มีข้อมูล → ตัดออก*

---

## 5. TOP-UP VS USAGE COMPARISON
- Line graph: Top-up vs Usage  
- Outstanding trend  
- Consumption trend  
- Revenue vs Estimated cost (ถ้าใช้ input จาก partner → ตอนนี้ตัดออก)

---

## 6. CHARGER PERFORMANCE
- ChargePoint ID  
- Total revenue  
- Total kWh  
- Sessions count  
- Charging Utilization = sum(duration)

*ข้อจำกัด:*  
- ไม่มี Offline history  
- ไม่มี Error history

---

## 7. ELECTRICITY COST REPORT  
*ตัดออกทั้งหมด เนื่องจากข้อมูล TOU / FT / Demand Charge ไม่รองรับ*

---

## 8. LINE ALERT SYSTEM
### Function:
- Partner login กด “Connect LINE Notify”
- ระบบเก็บ LINE access token
- Polling API `/partner/charge-point` ทุก 30–60 วินาที
- หากสถานะ Online → Offline หรือ ErrorCode เปลี่ยน → แจ้งเตือน

### Example Message:
```
Charger Alert
Station: ChiangMai-Nimman
Charger: CP-002
Status: Offline
Time: 14:22
```

---

## 9. EXPORT FUNCTIONS
- XLSX / CSV / PDF สำหรับทุกหน้า report  
- Dashboard PDF  
- Wallet Summary Excel  
- Charging Report Excel  
- Charger Performance PDF  

---

## NOT SUPPORTED (ต้องตัดออก)
- Payment Gateway Fee  
- TOU Rate / FT / Demand Charge  
- Error Log History  
- VAT report / e-tax  
- Promotion usage tracking  

---

## TIMELINE (12–16 days)
- Day 1–3: Dashboard base + API integration  
- Day 4–7: Wallet Summary + Top-up report  
- Day 8–10: Charger Performance + Heatmap  
- Day 11–13: LINE Notification  
- Day 14–16: Export, polishing, QA  


# GPARTNER UI PAGE STRUCTURE  
Version: 1.0

---

## /backend/dashboard
- Revenue card  
- kWh card  
- Sessions card  
- Line chart (Top-up vs Usage)  
- Heatmap peak hours  
- Revenue by charger (bar chart)  

---

## /backend/reports/wallet
- Summary table  
- Outstanding  
- Wallet by user  
- Wallet history drawer  

---

## /backend/reports/topups
- Table  
- Filters (date range, method, status)  
- Export XLSX  

---

## /backend/reports/usage
- Session table  
- Filters (charger, date range, user)  
- Export XLSX  

---

## /backend/reports/charger-performance
- Revenue per charger  
- kWh per charger  
- Utilization %  
- Export PDF  

---

## /backend/settings/line-connect
- ปุ่ม "Connect LINE Notify"  
- จอแสดงสถานะ (Connected / Not Connected)  


# GPARTNER API DATA MAPPING  
Version 1.0

---

## 1. Revenue Data → `/partner/revenue`
Used for:
- Dashboard  
- Usage report  
- Charger performance  
- Wallet usage  

Fields:
- transactionId  
- startTimestamp / stopTimestamp  
- meterStart / meterStop  
- totalFinal  
- Connector.chargePoint  
- Rated.User.email  
- Station.id  

Derived:
- kWh = (meterStop - meterStart) / 1000  
- Duration = stop - start  
- Efficiency = kWh / duration  

---

## 2. Top-up Data → `/partner/revenue/top-up`
Used for:
- Wallet summary  
- Top-up report  

Fields:
- topUpId  
- createdAt  
- totalFinal  
- paymentMethod  
- paymentStatus  

---

## 3. Charger Data → `/partner/charge-point`
Used for:
- Realtime status  
- LINE notification  

Fields:
- chargePointId  
- ConnectorActivity.status  
- ConnectorActivity.errorCode  

---

## Polling Logic for LINE Alerts
Every 30–60 seconds:
- fetch /partner/charge-point  
- compare last status  
- if changed → send LINE Notify  


# CLAUDE CODE IMPLEMENTATION PLAN  
Version: 1.0  
Purpose: เพื่อให้ Claude Code เขียนโค้ดได้อย่างถูกต้อง ไม่มีบั๊ก

---

## RULES
1. ใช้ Nuxt 3 + Vue 3 (setup script)  
2. ไม่ใช้ Pinia → ใช้ composables ตามโครงเดิม  
3. ใช้ useApi ที่มีแล้ว  
4. UI = Vuetify 3  
5. ใช้ dayjs สำหรับ date handling  
6. PDF = jsPDF  
7. XLSX = SheetJS  

---

## MODULES TO CREATE

### 1) Composables  
- useDashboard()  
- useWallet()  
- useTopupReport()  
- useUsageReport()  
- useChargerPerformance()  
- useLineAlert()  

### 2) Utils  
- kWh calculator  
- duration calculator  
- trend builder  
- exportXLSX  
- exportPDF  

### 3) Components  
- DashboardCards.vue  
- LineChart.vue  
- Heatmap.vue  
- ChargerBarChart.vue  
- WalletSummaryTable.vue  
- WalletHistory.vue  
- TopupTable.vue  
- UsageTable.vue  

### 4) Pages  
ตาม UI_PAGE_STRUCTURE.md

---

## IMPLEMENTATION ORDER
1. Integrate all partner APIs  
2. Build Dashboard data layer  
3. Build Wallet Summary  
4. Build Top-up Report  
5. Build Usage Report  
6. Build Charger Performance  
7. Add Export (XLSX/PDF)  
8. Implement LINE Notify OAuth + polling  
9. Final QA + optimize  

---

## TESTING
- Mock API responses  
- Validate all date filters  
- Validate grouping by charger  
- Validate Wallet calculations  
- Manual test LINE Alert  
